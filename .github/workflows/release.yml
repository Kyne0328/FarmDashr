name: Automated Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build_and_release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --obfuscate --split-debug-info=build/debug-info --split-per-abi

      - name: Sign APK
        uses: ilharp/sign-android-release@v2
        id: sign_app
        with:
          releaseDir: build/app/outputs/flutter-apk
          signingKey: ${{ secrets.ANDROID_KEYSTORE_BASE_64 }}
          keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          buildToolsVersion: 36.0.0

      - name: Generate Raw Changelog
        id: raw_changelog
        run: |
          # Get commits since last tag or all commits if no tag exists
          # Get the current tag (which triggered this workflow)
          current_tag=$(git describe --tags --abbrev=0)
          
          # Try to get the previous tag
          # We use ^ to look for the tag before the current one
          prev_tag=$(git describe --tags --abbrev=0 "$current_tag^" 2>/dev/null || echo "")
          
          echo "Current Tag: $current_tag"
          echo "Previous Tag: $prev_tag"
          
          if [ -z "$prev_tag" ]; then
            # No previous tag - log everything up to current tag
            git log "$current_tag" --pretty=format:"* %s" > raw_changelog.txt
          else
            # Log commits between previous tag and current tag
            git log "$prev_tag..$current_tag" --pretty=format:"* %s" > raw_changelog.txt
          fi
          echo "Raw changelog generated."

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install google-generativeai

      - name: Summarize Changelog with AI
        id: summarize
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scripts/summarize_changelog.py raw_changelog.txt

      - name: Get Version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: summarized_changelog.md
          files: build/app/outputs/flutter-apk/*-signed.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
